---
title: "Data analysis using statistical software: Descriptive statistics"
author: "Sho Kuroda / 黒田翔"
date: '2024-03-23 (Last update: 2024-03-23)'
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading data / データの読み込み

タイタニック号乗客データを読み込む．

```{r read_csv_external}
titanic <- read.csv("https://raw.githubusercontent.com/kurodaecon/bs/main/data/titanic3_csv.csv")
```

# Qualitative data / 質的データ

性別変数 `sex` を例に利用．

## Frequency table / 度数分布表

```{r ft}
table(titanic$sex)
```

`female` と `male` それぞれを数える場合．

```{r ft_manual}
head(titanic$sex)
head(titanic$sex == "female")  # logical ... TRUE or FALSE
sum(titanic$sex == "female")  # the number of TRUE = the number of female
sum(titanic$sex == "male")  # the number of male
```

この `table` 関数を利用してデータに欠損値 (NA) があるかを確認するとよい．
欠損値である場合に TRUE を返す関数 `is.na` を併用する．

```{r ft_na}
is.na(c(1, 10, NA, 1000))
table(is.na(c(1, 10, NA, 1000)))
table(is.na(titanic$sex))
```

## Bar chart / 棒グラフ

```{r bar}
barplot(table(titanic$sex))
```

## Pie chart / 円グラフ

```{r pie}
pie(table(titanic$sex))
```

Add percentage to labels.

ラベルに「%」を追加する．

```{r pie2}
titanic_sex_table <- table(titanic$sex)
titanic_sex_label <- paste(names(titanic_sex_table), " ", 
                     round(100 * titanic_sex_table / sum(titanic_sex_table), 1), "%", sep = "")
pie(titanic_sex_table, labels = titanic_sex_label)
```

### Supplement 

上のごちゃごちゃしたコードはどのように動いているのか？

```{r pie2_detail}
paste("male", 35.6, "%", sep = "")
titanic_sex_table / sum(titanic_sex_table)
round(titanic_sex_table / sum(titanic_sex_table), 1)
```


## Contingency table / 分割表

Specify two arguments, e.g., sex and survived, in the `table` function.

```{r ct}
table(titanic$sex, titanic$survived)
```

セルを1つずつカウントすることもできる．

```{r ct2}
sum(titanic$sex == "female" & titanic$survived == 0)
sum(titanic$sex == "female" & titanic$survived == 1)
sum(titanic$sex == "male" & titanic$survived == 0)
sum(titanic$sex == "male" & titanic$survived == 1)
```

## Mode / 最頻値

出港地を例として．

```{r mode}
table(titanic$embarked)
names(which.max(table(titanic$embarked)))
```



# Quantitative data / 量的データ

年齢変数 `age` を例に利用．
欠損値もある．

```{r age_count_na}
head(titanic$age)
table(is.na(titanic$age))
```

## Histogram / ヒストグラム

```{r apple_hist}
hist(titanic$age)
hist(titanic$age, breaks = 30)  # set the number of cells
```

## Frequency distribution table of quantitative data / 数量データの度数分布表

[0, 20), [20, 60), [60, 100) の3区間で作成する．
そのために，`cut` 関数を利用して実数データを上の3区間に変換する．

```{r apple_fd}
titanic_age_interval <- cut(titanic$age, breaks = c(0, 20, 60, 100), right = FALSE)
# [right = F] means intervals should not be closed on the right
table(titanic_age_interval)
table(titanic_age_interval) / sum(table(titanic_age_interval))  # relative frequency
```

## Mean / 平均

$$ \bar{x} = \frac{1}{n} \sum_i x_i $$

```{r mean}
x <- c(1, 2, 6)
1 + 2 + 6  # sum (1+2+6=9)
sum(x)  # sum
sum(x) / 3  # definition of mean
mean(x)
mean(c(1, 2, 6))  # same as above / このように書いても同じ結果が得られる
```

### Example of age variable of Titanic data / タイタニック号乗客データの年齢変数

欠損値 `NA` があると計算結果も `NA` になる．
その場合は `NA` を除外して平均を計算するために `na.rm = TRUE` 引数を追加する．

```{r mean_age}
mean(titanic$age)
mean(titanic$age, na.rm = TRUE)
```


## Quantiles, median / 分位数，中央値

```{r quantiles}
quantile(c(1, 2, 4, 7, 8, 11, 13, 13, 15, 16, 18))  # returns quartiles as default 四分位数
quantile(titanic$age, na.rm = TRUE)
summary(titanic$age)
```

The `summary` function also reports the quartiles.

summary関数も四分位点を報告するが，quantile関数を使った場合と少し値が違う場合もある．

```{r apple_quantiles2}
quantile(titanic$age, probs = seq(0.1, 0.9, by = 0.1), na.rm = TRUE)  # deciles 十分位数
quantile(titanic$age, probs = 0.35, na.rm = TRUE)  # 35th percentile
median(titanic$age, na.rm = TRUE)  # median 中央値
```


## Maximum, Minimum, Range / 最大値，最小値，範囲

```{r max_min_range}
max(titanic$age); min(titanic$age)
max(titanic$age, na.rm = TRUE); min(titanic$age, na.rm = TRUE)
max(titanic$age, na.rm = TRUE) - min(titanic$age, na.rm = TRUE)  # range
```


## Variance and standard deviation / 分散と標準偏差

$$ s^2 = \frac{1}{n-1} \sum_i (x_i - \bar{x})^2, \quad s = \sqrt{s^2} $$

```{r var}
x <- c(1, 2, 6)
x - 3
x - mean(x)
(x - mean(x))^2
mean((x - mean(x))^2)  # definition of population variance
sum((x - mean(x))^2) / 3  # same as above
sum((x - mean(x))^2) / (3-1)  # definition of sample variance (unbiased variance)
var(x)  # variance defined as sample variance
sqrt(var(x))  # definition of standard deviation
sd(x)
```

### Example of dice roll

Expected value and variance of the dice roll.

サイコロの出目の期待値と分散

$$ E(X) = \sum_j^k x_j f(x_j), \quad V(X) = E[(X-E(X))^2] = \sum_j^k (x_j - E(X))^2 f(x_j) = E(X^2) - (E(X))^2 $$ 

```{r dice}
dice <- 1:6  # c(1, 2, 3, 4, 5, 6) と同じ
sum(dice * (1/6))  # definition of expectation
mean(dice)  # mean
sum((dice - mean(dice))^2 * (1/6))  # variance: sum[(x-E(X))*f(x)]
sum(dice^2 * (1/6)) - sum(dice * (1/6))^2  # variance: E(X^2)-E(X)^2
```

The value of `var(dice)` is 3.5, which does not equal the above, but this is because the `var` function calculates the sample variance (unbiased variance); `3.5*(n-1)/n = 3.5*5/6 ≈ 2.9`.

なお `var(dice)` を計算すると3.5となり，上記と一致しないが，これは `var` 関数が標本分散（不偏分散）を計算するためである．`3.5*(n-1)/n = 3.5*5/6 ≒ 2.9` である．

### Example of age variable of Titanic data / タイタニック号乗客データの年齢変数

欠損値 `NA` があると計算結果も `NA` になる．
その場合は `NA` を除外して平均を計算するために `na.rm = TRUE` 引数を追加する．

```{r var_age}
var(titanic$age)
var(titanic$age, na.rm = TRUE)
sd(titanic$age, na.rm = TRUE)
```


### Box plot / 箱ひげ図

```{r apple_box}
boxplot(titanic$age) 
titanic_age_female <- titanic$age[titanic$sex == "female"]  # age of female 
titanic_age_male <- titanic$age[titanic$sex == "male"]  # age of male 
boxplot(titanic_age_female, titanic_age_male, names = c("Female", "Male"), ylab = "Age") 
boxplot(age ~ sex, titanic)  # same as above 
```



## Scatter plot / 散布図

```{r scatter}
plot(x = titanic$age, y = titanic$fare, xlab = "Age", ylab = "Fare", pch = 20)
```

### Scale does matter

Same data but difference scale (on y-axis).

```{r scatter_scaleismatter}
tempx <- 1:10
set.seed(1)
tempy <- tempx + rnorm(10, sd = 4)
par(mfrow = c(1, 2))
plot(tempx, tempy, xlab = "x", ylab = "y", pch = 20)
plot(tempx, tempy, xlab = "x", ylab = "y", pch = 20, ylim = c(-50, 50))
```

The left figure appears to show a positive correlation, while the right figure will look uncorrelated. 

左の図は正の相関を示しているように見えるが，右の図は無相関に見えるだろう．

### Non-linear relationship

Y軸のみ対数変換する場合は `log = "y"`，X軸とY軸の両方を対数変換する場合は `log = "xy"` を引数に追加する．

```{r plot_non_linear}
plot(x = titanic$age, y = titanic$fare, xlab = "Age", ylab = "Fare", pch = 20, log = "y")
```

### Data points overlap 

`col = "red"` のように引数を追加することでマーカーの色を指定できる．
`col = rgb(red, green, blue)` のように引数を追加すれば，RGB形式で色を指定できる．
`col = rgb(red, green, blue, alpha)` のように引数を追加すれば，RGB形式で色を指定したうえに，透過水準を alpha 値（0以上1以下）として指定できる．


```{r plot_overlap}
plot(x = titanic$age, y = titanic$fare, xlab = "Age", ylab = "Fare", pch = 20, col = rgb(0, 0, 0, .3))
```

### Scatter plot with jitter 

Without jitter

```{r plot_no_jitter}
plot(x = titanic$pclass, y = titanic$parch, xlab = "Ticket class", 
     ylab = "# of parents and children", pch = 20)
```

With jitter

```{r plot_jitter}
plot(x = jitter(titanic$pclass), y = jitter(titanic$parch), xlab = "Ticket class", 
     ylab = "# of parents and children", pch = 20, cex = .5)
```

### Binned scatter plot 

Raw plot

```{r plot_no_bin}
plot(x = titanic$age, y = titanic$survived, xlab = "Age", ylab = "Survived", pch = 20)
```

Binned plot

```{r plot_bin}
titanic_with_age <- titanic[!is.na(titanic$age), ]  # remove obs. with no age 
titanic_age_6 <- cut(titanic_with_age$age, breaks = 6)  # convert age into 6 intervals
levels(titanic_age_6)
titanic_mean_age <- c((0.0902+13.5)/2, (13.5+26.8)/2, (26.8+40.1)/2, 
                      (40.1+53.4)/2, (53.4+66.7)/2, (66.7+80.1)/2)
titanic_mean_survived <- c(
 mean(titanic_with_age$survived[titanic_age_6 == levels(titanic_age_6)[1]]),
 mean(titanic_with_age$survived[titanic_age_6 == levels(titanic_age_6)[2]]),
 mean(titanic_with_age$survived[titanic_age_6 == levels(titanic_age_6)[3]]),
 mean(titanic_with_age$survived[titanic_age_6 == levels(titanic_age_6)[4]]),
 mean(titanic_with_age$survived[titanic_age_6 == levels(titanic_age_6)[5]]),
 mean(titanic_with_age$survived[titanic_age_6 == levels(titanic_age_6)[6]]) )
plot(x = titanic_mean_age, y = titanic_mean_survived, 
     xlab = "Age (binned)", ylab = "Survival rate", pch = 20)
```

注：Binned plot を計算するための便利なパッケージが幾つかあるため，実際に描画する際にはそれを利用するとよい．

## Covariance and correlation / 共分散と相関係数

$$ Cov(x, y) = \frac{1}{n-1} \sum_i (x_i - \bar{x})(y_i - \bar{y}) $$

```{r cov}
x <- c(1, 2, 6)
x2 <- c(1, 3, 4)
plot(x, x2)  # scatter plot
(x - mean(x)) * (x2 - mean(x2))
sum((x - mean(x)) * (x2 - mean(x2))) / 3  # definition of sample covariance
sum((x - mean(x)) * (x2 - mean(x2))) / (3-1)  # definition of sample covariance
cov(x, x2)  # covariance of unbiased covariance
```

$$ Cor(x, y) = \frac{Cov(x, y)}{\sqrt{V(x)} \cdot \sqrt{V(y)}} $$

```{r cor}
cov(x, x2) / (sd(x) * sd(x2))  # definition of correlation coef.
cor(x, x2)  # correlation coefficient
```

Correlation coefficients of 1 or -1 are obtained when one variable is a constant multiple or constant addition of the other variable.

相関係数が 1 や -1 になるのは，一方の変数がもう一方の変数の定数倍・定数加算によって得られるような場合です．

```{r cov2}
x3 <- x * 2 + 3
x4 <- x * (-0.5) + 3
var(x3); 2^2 * var(x)  # These two should have the same value / この2つは同じ値になるはず
par(mfrow = c(1, 2))
plot(x, x3); abline(lm(x3 ~ x), col = "red")  # Add regression line (red line) / 回帰直線を追加
plot(x, x4); abline(lm(x4 ~ x), col = "red")
cor(x, x3)
cor(x, x4)
```

### Anscombe's quartet / アンスコムの数値例

See <https://en.wikipedia.org/wiki/Anscombe%27s_quartet>

Four sets of variables {x, y} are included, whose mean, variance, and correlation coefficients are approximately the same, although the relationship between the variables is different from each other.

変数の関係が互いに異なるが平均・分散・相関係数が概ね同じ {x, y} という変数の組が4セット含まれる．

```{r sampledata_anscombe}
str(anscombe)  # display structure of object
summary(anscombe)
mean(anscombe$x1)
apply(anscombe, 2, mean)  # mean
apply(anscombe, 2, var)  # variance

par(mfrow = c(2, 2))
plot(anscombe$x1, anscombe$y1)
plot(anscombe$x2, anscombe$y2)
plot(anscombe$x3, anscombe$y3)
plot(anscombe$x4, anscombe$y4)
cor(anscombe$x1, anscombe$y1)  # correlation of x1 and y1
cor(anscombe$x2, anscombe$y2)
cor(anscombe$x3, anscombe$y3)
cor(anscombe$x4, anscombe$y4)
```

This example shows us the importance of drawing raw data, rather than just looking at descriptive statistics. 

この例は，記述統計だけを見るのではなく，生のデータを描画することの重要性を我々に教えてくれる．

See also: Same Stats, Different Graphs <https://www.research.autodesk.com/publications/same-stats-different-graphs/>


### Example of age variable of Titanic data / タイタニック号乗客データの年齢変数

少なくとも一方の変数に欠損値 `NA` がある場合は，欠損値がない観測値のみを使って相関係数を計算するために `use = "complete.obs"` 引数を追加する．

```{r cor_titanic}
cor(titanic$age, titanic$fare, use = "complete.obs")
```




.
